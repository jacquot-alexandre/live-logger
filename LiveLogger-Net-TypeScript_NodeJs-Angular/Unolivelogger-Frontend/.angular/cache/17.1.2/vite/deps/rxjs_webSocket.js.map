{
  "version": 3,
  "sources": ["../../../../../node_modules/rxjs/dist/esm5/internal/observable/dom/WebSocketSubject.js", "../../../../../node_modules/rxjs/dist/esm5/internal/observable/dom/webSocket.js"],
  "sourcesContent": ["import { __assign, __extends } from \"tslib\";\nimport { Subject, AnonymousSubject } from '../../Subject';\nimport { Subscriber } from '../../Subscriber';\nimport { Observable } from '../../Observable';\nimport { Subscription } from '../../Subscription';\nimport { ReplaySubject } from '../../ReplaySubject';\nvar DEFAULT_WEBSOCKET_CONFIG = {\n    url: '',\n    deserializer: function (e) { return JSON.parse(e.data); },\n    serializer: function (value) { return JSON.stringify(value); },\n};\nvar WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT = 'WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }';\nvar WebSocketSubject = (function (_super) {\n    __extends(WebSocketSubject, _super);\n    function WebSocketSubject(urlConfigOrSource, destination) {\n        var _this = _super.call(this) || this;\n        _this._socket = null;\n        if (urlConfigOrSource instanceof Observable) {\n            _this.destination = destination;\n            _this.source = urlConfigOrSource;\n        }\n        else {\n            var config = (_this._config = __assign({}, DEFAULT_WEBSOCKET_CONFIG));\n            _this._output = new Subject();\n            if (typeof urlConfigOrSource === 'string') {\n                config.url = urlConfigOrSource;\n            }\n            else {\n                for (var key in urlConfigOrSource) {\n                    if (urlConfigOrSource.hasOwnProperty(key)) {\n                        config[key] = urlConfigOrSource[key];\n                    }\n                }\n            }\n            if (!config.WebSocketCtor && WebSocket) {\n                config.WebSocketCtor = WebSocket;\n            }\n            else if (!config.WebSocketCtor) {\n                throw new Error('no WebSocket constructor can be found');\n            }\n            _this.destination = new ReplaySubject();\n        }\n        return _this;\n    }\n    WebSocketSubject.prototype.lift = function (operator) {\n        var sock = new WebSocketSubject(this._config, this.destination);\n        sock.operator = operator;\n        sock.source = this;\n        return sock;\n    };\n    WebSocketSubject.prototype._resetState = function () {\n        this._socket = null;\n        if (!this.source) {\n            this.destination = new ReplaySubject();\n        }\n        this._output = new Subject();\n    };\n    WebSocketSubject.prototype.multiplex = function (subMsg, unsubMsg, messageFilter) {\n        var self = this;\n        return new Observable(function (observer) {\n            try {\n                self.next(subMsg());\n            }\n            catch (err) {\n                observer.error(err);\n            }\n            var subscription = self.subscribe({\n                next: function (x) {\n                    try {\n                        if (messageFilter(x)) {\n                            observer.next(x);\n                        }\n                    }\n                    catch (err) {\n                        observer.error(err);\n                    }\n                },\n                error: function (err) { return observer.error(err); },\n                complete: function () { return observer.complete(); },\n            });\n            return function () {\n                try {\n                    self.next(unsubMsg());\n                }\n                catch (err) {\n                    observer.error(err);\n                }\n                subscription.unsubscribe();\n            };\n        });\n    };\n    WebSocketSubject.prototype._connectSocket = function () {\n        var _this = this;\n        var _a = this._config, WebSocketCtor = _a.WebSocketCtor, protocol = _a.protocol, url = _a.url, binaryType = _a.binaryType;\n        var observer = this._output;\n        var socket = null;\n        try {\n            socket = protocol ? new WebSocketCtor(url, protocol) : new WebSocketCtor(url);\n            this._socket = socket;\n            if (binaryType) {\n                this._socket.binaryType = binaryType;\n            }\n        }\n        catch (e) {\n            observer.error(e);\n            return;\n        }\n        var subscription = new Subscription(function () {\n            _this._socket = null;\n            if (socket && socket.readyState === 1) {\n                socket.close();\n            }\n        });\n        socket.onopen = function (evt) {\n            var _socket = _this._socket;\n            if (!_socket) {\n                socket.close();\n                _this._resetState();\n                return;\n            }\n            var openObserver = _this._config.openObserver;\n            if (openObserver) {\n                openObserver.next(evt);\n            }\n            var queue = _this.destination;\n            _this.destination = Subscriber.create(function (x) {\n                if (socket.readyState === 1) {\n                    try {\n                        var serializer = _this._config.serializer;\n                        socket.send(serializer(x));\n                    }\n                    catch (e) {\n                        _this.destination.error(e);\n                    }\n                }\n            }, function (err) {\n                var closingObserver = _this._config.closingObserver;\n                if (closingObserver) {\n                    closingObserver.next(undefined);\n                }\n                if (err && err.code) {\n                    socket.close(err.code, err.reason);\n                }\n                else {\n                    observer.error(new TypeError(WEBSOCKETSUBJECT_INVALID_ERROR_OBJECT));\n                }\n                _this._resetState();\n            }, function () {\n                var closingObserver = _this._config.closingObserver;\n                if (closingObserver) {\n                    closingObserver.next(undefined);\n                }\n                socket.close();\n                _this._resetState();\n            });\n            if (queue && queue instanceof ReplaySubject) {\n                subscription.add(queue.subscribe(_this.destination));\n            }\n        };\n        socket.onerror = function (e) {\n            _this._resetState();\n            observer.error(e);\n        };\n        socket.onclose = function (e) {\n            if (socket === _this._socket) {\n                _this._resetState();\n            }\n            var closeObserver = _this._config.closeObserver;\n            if (closeObserver) {\n                closeObserver.next(e);\n            }\n            if (e.wasClean) {\n                observer.complete();\n            }\n            else {\n                observer.error(e);\n            }\n        };\n        socket.onmessage = function (e) {\n            try {\n                var deserializer = _this._config.deserializer;\n                observer.next(deserializer(e));\n            }\n            catch (err) {\n                observer.error(err);\n            }\n        };\n    };\n    WebSocketSubject.prototype._subscribe = function (subscriber) {\n        var _this = this;\n        var source = this.source;\n        if (source) {\n            return source.subscribe(subscriber);\n        }\n        if (!this._socket) {\n            this._connectSocket();\n        }\n        this._output.subscribe(subscriber);\n        subscriber.add(function () {\n            var _socket = _this._socket;\n            if (_this._output.observers.length === 0) {\n                if (_socket && (_socket.readyState === 1 || _socket.readyState === 0)) {\n                    _socket.close();\n                }\n                _this._resetState();\n            }\n        });\n        return subscriber;\n    };\n    WebSocketSubject.prototype.unsubscribe = function () {\n        var _socket = this._socket;\n        if (_socket && (_socket.readyState === 1 || _socket.readyState === 0)) {\n            _socket.close();\n        }\n        this._resetState();\n        _super.prototype.unsubscribe.call(this);\n    };\n    return WebSocketSubject;\n}(AnonymousSubject));\nexport { WebSocketSubject };\n", "import { WebSocketSubject } from './WebSocketSubject';\nexport function webSocket(urlConfigOrSource) {\n    return new WebSocketSubject(urlConfigOrSource);\n}\n"],
  "mappings": "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",
  "names": ["WebSocketSubject"]
}
